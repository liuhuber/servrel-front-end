<!DOCTYPE html>
<meta charset="utf-8">
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>SERVREL</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="scriptStyle.css">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <!--script src="https://code.jquery.com/jquery-1.10.2.js"></script-->
    <!--script src="http://code.jquery.com/jquery-latest.pack.js"></script-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <!--script src="http://mbostock.github.com/d3/d3.js"></script-->
    <script src="layer-v2.3/layer/layer.js"></script>
    <!--script src="http://res.layui.com/lay/lib/layer/src/layer.js?v=2.3"></script-->

    <script type="text/javascript" src="drawBall-2.js"></script>
    <script type="text/javascript" src="WdrawBall.js"></script>
	<script type="text/javascript" src="jquery.tipsy.js"></script>
    <link href="tipsy.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript">
        var countballs = 1;
        var root = {
            "id": "",
            "name": "root"
        };

        function defaultTab(apiid) {
            var _default = 0,
                $block = $('#apiblock_' + apiid),
                $tabs = $block.find('.tabs_' + apiid),
                $tabsLi = $tabs.find('li'),
                $tab_content = $block.find('.tabContent_' + apiid),
                $tab_contentLi = $tab_content.find('li'),
                _width = $tab_content.width();

            var lastActive = $tabsLi.filter('.active').index();

            if (lastActive >= 0)
                _default = lastActive;
            //console.log("default = " + _default);

            // 先把預設要顯示的頁籤加上 .active 樣式及顯示相對應的內容
            $tabsLi.eq(_default).addClass('active');
            $tab_contentLi.eq(_default).siblings().css({
                left: _width
            });

        }

        function showAPIBlock(apiid) {
            //$(function(){
            // 預設顯示第一個頁籤
            // 並先把 .tabs, .tabs li 及 .tab_content, .tab_content li 等元素取出
            // 同時也要取得 .tab_content 的寬
            var _default = 0,
                $block = $('#apiblock_' + apiid),
                $tabs = $block.find('.tabs_' + apiid),
                $tabsLi = $tabs.find('li'),
                $tab_content = $block.find('.tabContent_' + apiid),
                $tab_contentLi = $tab_content.find('li'),
                _width = $tab_content.width();

            // 當滑鼠移到 .tabs li 上時要套用 .hover 樣式
            // 移出時要移除 .hover 樣式
            $tabsLi.hover(function() {
                var $this = $(this);

                // 若被滑鼠移上去的 li 是目前顯示的頁籤就不做任何動作
                if ($this.hasClass('active')) return;

                $this.toggleClass('hover');
            }).click(function() { // 當滑鼠點擊 .tabs li 時
                // 先取出被點擊及目前顯示的頁籤與索引
                var $active = $tabsLi.filter('.active').removeClass('active'),
                    _activeIndex = $active.index(),
                    $this = $(this).addClass('active').removeClass('hover'),
                    _index = $this.index(),
                    isNext = _index > _activeIndex;

                // 如果被點擊的頁籤就是目前已顯示的頁籤, 則不做任何動作
                if (_activeIndex == _index) return;

                // 依索引大或小來決定移動的位置
                $tab_contentLi.eq(_activeIndex).stop().animate({
                    left: isNext ? -_width : _width
                }).end().eq(_index).css('left', isNext ? _width : -_width).stop().animate({
                    left: 0
                });
            });
        }
    </script>

    <script>
        function addIn() {
            $("#inTable").append("<tr><td>Input: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input name='inputs' type='text'><br>TestData: <input name='testdata' type='text'></td></tr>");
        }
        var outNum = 2;

        function addOut() {
            $("#outTable").append("<tr><td>Output: &nbsp;&nbsp;&nbsp;&nbsp;<input name='outputs' type='text'><br><div id='field_exp_" + outNum + "'>Expected: <input name='exp_" + outNum + "' type='text'><img class='addExp' id='exp_" + outNum + "' src='addButton.jpg' style='width:16px'></div></td></tr>");
            outNum++;
        }

        function hasPic(pic) {
            if (pic == "")
                return "SERVREL.png";
            else
                return pic;
        }

        function showTable() {
            var id = "";
            $(".apititle").click(function() {
                titleID = this.id;
                id = titleID.substring(9);
                $(this).toggleClass("selected").siblings('.content_' + id).toggle(0, function() {
                    if ($(".content_" + id).is(":visible")) {
                        defaultTab(id);
                    }
                    showAPIBlock(id);
                });

            });
        }

        function backSearch() {
            var content = "<div id='searchForm'><form method='get' action='JavaScript:search()'><div class='searchType'><input type='radio' id='keywordtype' name='searchtype' value='keyword' checked='true'><label for='keywordtype'>Search by keyword</label><input type='radio' id='IO' name='searchtype' value='IO'><label for='IO'>Search by inputs and outputs</label></div><div id = 'searchContent'></div><input type='submit' id = 'go' value='search' ></form></div>";

            $('#leftPart').html(content);
            $('#searchForm').css("display", "none");
            $('#searchForm').slideDown("slow");

            var t = $("input[name='searchtype']:checked").val();
            var formCon = "";
            if (t == "keyword") {
                formCon = "Keyword: <input type='text' id='keyword'>";
                $("#searchContent").html(formCon);
            } else {
                formCon = "Description: <input type='text' id='description'><br><table id='inTable'><tr><td>Input: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input name='inputs' type='text'><br>TestData: <input name='testdata' type='text'></td></tr></table><img id='inBtn' class='add' src='addItem.png' onclick='addIn()'><table id='outTable'><tr><td>Output: &nbsp;&nbsp;&nbsp;&nbsp;<input name='outputs' type='text'><br><div id='field_exp_1'>Expected: <input name='exp_1' type='text'><img class='addExp' id='exp_1' src='addButton.jpg' style='width:16px'></div></td></tr></table><img id='outBtn' class='add' src='addItem.png' onclick='addOut()'>";
                $("#searchContent").html(formCon);
            }
            getSearchForm();
        }

        function getResult(data) {
            var lang = "<table id='result' rules='rows'><tbody>";
            var a = new Array();

            $.each(data, function() {
                var myID = "\"" + this['id'] + "\"";
                a = this['name'].split(".json", 1);
                lang += "<tr class='apititle' id=apititle_" + this['id'] + " ><td style='width:10%;'><img id=" + this['id'] + " class='logo' title=" + a[0] + " style='width:100%;' draggable='true' ondragstart='dragstartHandler(event)' src=" + hasPic(this['pic']) + "></td><td colspan='3' style='width:70%;'><h3>" + a[0] + "</h3></td><td colspan='2' style='width:10%;'><img src='workspacepeople_title.png'><h4> " + this['workspacepeople'] + "</h4></td><td colspan='2' style='width:10%;'><img id='faImgL_" + a[0] + "' class='list_favorImg' src='favorpeople.png'><h4> " + this['favorpeople'] + "</h4></td></tr><tr id='content' class='content_" + this['id'] + "'><td colspan='8'><div class='apiblock' id='apiblock_" + this['id'] + "'><ul id='tabs' class='tabs_" + this['id'] + "'><li>Info</li><li>Pre</li><li>Post</li><li>Comp</li></ul><ul id='tabContent' class='tabContent_" + this['id'] + "'><li id='info_" + this['id'] + "'></li><li id='pre_" + this['id'] + "'></li><li id='pos_" + this['id'] + "'></li><li id='com_" + this['id'] + "'></li></ul></div></td></tr>";

                getInfo(myID, this['id']);
                getPre(myID, this['id']);
                getPost(myID, this['id']);
                getComp(myID, this['id']);

            });
            lang += "</tbody></table>";

            $('#leftPart').html(lang);
            $('#result').css("display", "none");
			$("#load").hide();
            $('#result').slideDown("normal");
            showTable();
			
			if (localStorage.userID != undefined) {
				$('.list_favorImg').hover(function() {
					$(this).attr("src", "addfavor.png");
					$(this).css("cursor", "pointer");
				}, function() {
					$(this).attr("src", "favorpeople.png");
				});

				$('.list_favorImg').click(function(event) {
					event.stopPropagation();
					var apiName = (this.id).substring(7) + ".json";
					var that = this;
					console.log("apiName:" + apiName);
					var con = "<form action='JavaScript:addFavorAPI(\"" + apiName + "\")'><center><font size=5>Category</font><hr color='#08605F' style='margin: 5px;'></center><div><select id='selectClass'>";

					var site = "http://140.121.197.135:7778/servrel/favorite?userID=" + localStorage.userID;
					$.when($.getJSON(site, function(result) {
						$.each(result, function() {
							con += "<option value='" + this + "'>" + this + "</option>";
						});
						con += "<option value='newCategory'>Create a new category</option></select><br><input type='text' id='newClass' placeholder='Category name' required></div><input class='favorOK' type='submit' value='OK'></form>";
					})).done(function() {						
						layer.tips(con, that, {
							tips: [3, '#3BA99C'],
							time: 0,
							skin: 'favorTip',
							shade: [0, '#FFFFF'],
							shadeClose: true
						});
						
						if ($("#selectClass").val() != "newCategory") {
							$("#newClass").hide();
							$("#newClass").val("no");
						}

						$("#selectClass").change(function() {
							if ($("#selectClass").val() == "newCategory") {
								$("#newClass").val("");
								$("#newClass").show();
							} else {
								$("#newClass").hide();
								$("#newClass").val("no");
							}
						});
						
					});
					
				});
			}
			
        }


        var isSearchAjax = false;

        $(document).ajaxStart(function() {
            if (isSearchAjax == true) {
                $("#load").show();
            }
        });
        $(document).ajaxStop(function() {
            if (isSearchAjax == true) {
                //$("#load").hide();
                //$('#result').slideDown("normal");
                isSearchAjax = false;
            }
        });

        function search() {
            var type = $("input[name='searchtype']:checked").val();
            if (type == "keyword") {
                var key = $("#keyword").val();
                var site = "http://140.121.197.135:7778/servrel/search/keyword?text=" + key;
                console.log(site);
                isSearchAjax = true;
                $.getJSON(site, function(result) {
                    getResult(result);
                });
            } else {
                var des = $("#description").val();
                var ins = document.getElementsByName('inputs');
                var tests = document.getElementsByName('testdata');
                var outs = document.getElementsByName('outputs');
                var input = "[";
                var output = "[";

                for (var i = 0; i < ins.length; i++) {
                    if (i == 0) {
                        input += "{\"name\":\"" + ins[i].value + "\",\"testData\":\"" + tests[i].value + "\"}";
                    } else {
                        input += ",{\"name\":\"" + ins[i].value + "\",\"testData\":\"" + tests[i].value + "\"}";
                    }
                }
                input += "]";

                for (var i = 0; i < outs.length; i++) {
                    var e = "exp_" + (i + 1);
                    var exps = document.getElementsByName(e);
                    var t = "";
                    if (i == 0) {
                        output += "{\"name\":\"" + outs[i].value + "\",\"expected\":[";
                        for (var j = 0; j < exps.length; j++) {
                            if (j == 0) {
                                t = "\"" + exps[j].value + "\"";
                            } else {
                                t += ",\"" + exps[j].value + "\"";
                            }
                        }
                        output += t + "]}";
                    } else {
                        output += ",{\"name\":\"" + outs[i].value + "\",\"expected\":[";
                        for (var j = 0; j < exps.length; j++) {
                            if (j == 0) {
                                t = "\"" + exps[j].value + "\"";
                            } else {
                                t += ",\"" + exps[j].value + "\"";
                            }
                        }
                        output += t + "]}";
                    }
                    output += "]";
                }
                var site = "http://140.121.197.135:7778/servrel/search/io?inputs=" + input + "&outputs=" + output + "&description=" + des;
                console.log(site);
                isSearchAjax = true;
                $.getJSON(site, function(result) {
                    getResult(result);
                });
            }
        }

        /*var width = "100%";
        var height = "100%";
        var svg = d3.select("#visualization").append("svg")
        		.attr("width", width)
        		.attr("height", height);*/

        function dragstartHandler(event) {
            event.dataTransfer.setData("text/plain", event.currentTarget.id);
            event.dataTransfer.effectAllowed = "copy";
        }

        function dragoverHandler(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = "copy";
        }

        function getDraw() {
            var width = "95%";
            var height = "95%";
            var svg = d3.select("#visualization").append("svg")
                .attr("width", 800)
                .attr("height", 800)
                .append("g")
                .attr("transform", function(d) {
                    return "translate(" + 400 + "," + 400 + ")";
                });
            /*var svg = d3.select("#visualization").append("svg")
                .attr("width", width)
                .attr("height", height)
				;*/
            return svg;
        }

        var countLogo = 0;
        var svg;

        function dropHandler(event) {
            var did = event.dataTransfer.getData("text/plain");
            var d = document.getElementById(did);
            /*var img = document.createElement('img');
            imgId = d.id + "_new";
            img.setAttribute("id", imgId);
            img.src = d.src;
            img.title = d.title;
            img.setAttribute("width", "50px");*/

            //event.currentTarget.appendChild(img);
            event.preventDefault();

            if (countLogo == 0) {
                svg = getDraw();
            }
			
            console.log("API ID: " + d.id); //ID:若是搜尋後相關API表格裡的API，ID是"rel_XXX"
            console.log("API name: " + d.title); //API名稱
            console.log("API pic: " + d.src); //API圖片

            drawBall(svg, countballs, d.id, d.title, d.src);
            countballs++;
            countLogo++;
        }

        var newGraph = 0;

        function newgraph() {
            var con = "<form action='JavaScript:sendData()' method='get'><input type='text' data-provide='typeahead' name='projectname'><input class='btn btn-primary' type='submit' value='OK'><input class='btn btn-primary' type='submit' onclick='javascript:clearAll();return false;' value='Cancel'></form>";
            newGraph = 1;
            $('#New').popover({
                title: 'Save as a project?:',
                trigger: 'click',
                html: true,
                content: con,
            });
        }

        function clearAll() {
            root = {
                "id": "",
                "name": "root",
                "visible": 0
            };
            console.log(root);
            d3.select("svg").remove();
            countballs = 1;
            countLogo = 0;
        }

        function openProject() {
            var list = "";
            var site = "http://140.121.197.135:7778/servrel/workspace?userID=" + localStorage.userID;
            $.getJSON(site, function(result) {
                console.log(result);
                $.each(result, function() {
                    if (this != 200) {
                        var ptname = this;
                        ptname = ptname.substr(1, ptname.length - 2);
                        console.log(ptname);
                        var name = ptname.split(/,/);
                        list += "<ul class='list-group'>";
                        for (key in name) {
                            name[key] = name[key].substr(1, name[key].length - 2);
                            console.log(name[key]);
                            if (name[key] != "") {
                                list += "<a href='#'<li class='list-group-item' id='" + name[key] + "'>" + name[key] + "</li></a>";
                            }
                        }
                        list += "</ul>";
                    }
                });
                //$("#classList").html(list);
                //opendata();
                console.log(list);
                $('#Open').popover({                    
                    trigger: 'click',
                    html: true,
                    content: list,
                });
            });
            //var con = "<form action='JavaScript:sendData()' method='get'><input type='text' data-provide='typeahead' name='projectname'><input class='btn btn-primary' type='submit' value='OK'><input class='btn btn-primary' type='submit' onclick='javascript:clearAll();return false;' value='Cancel'></form>";
            newGraph = 1;
        }

        function savedata() {
            //$('[data-toggle="popover"]').popover(); 
            var con = "<form action='JavaScript:sendData()' method='get'><input type='text' data-provide='typeahead' name='projectname'><input class='btn btn-primary' type='submit' value='OK'></form>";
            $('#Save').popover({
                title: 'Project Name:',
                trigger: 'click',
                html: true,
                content: con,
            });
            console.log(root);
            // alert(root);				
        }
        
        function sendData() {
            var ptname = $('input[name="projectname"]').val();
            var wsite = "http://140.121.197.135:7778/servrel/workspace/project";
            var dataroot = root.toSource();
			//var dataroot=JSON.stringify(root);
            //var dataroot=shallowStringify(root);
            //var dataroot=eval(root);
            /*$.post(wsite, 
			      {"projectname": ptname, "data": dataroot},  
				  function(data, status){alert("Data: " + data + "\nStatus: " + status);}				  
                  );*/

            console.log(dataroot);
            $.post(wsite, {
                "project": ptname,
                "data": dataroot,
                "userID": localStorage.userID
            }, function(result) {
                console.log("post: " + JSON.stringify(result));
                if (result.code == "200") {
                    alert("Success");
                } else {
                    console.log("逆失敗惹");
                }
            }, "json");
            if (newGraph == 1) {
                clearAll();
                newGraph = 0;
            }
            /* $.ajax({
                type: "POST",
                url: "http://140.121.197.135:7778/servrel/workspace/project",
                data: {
                    project: ptname,
                    data: dataroot,
					userID:localStorage.userID
                },
                contentType: "application/json",
                dataType: "json",
                　success: function(data) {
                    console.log("success");　　　　　
                    console.log(data);
                },
                　error: function() {
                    console.log("error");　
                    console.log(data);
                }
            });*/
        }

        function shallowStringify(obj, onlyProps, skipTypes) {
            var objType = typeof(obj);
            if (['function', 'undefined'].indexOf(objType) >= 0) {
                return objType;
            } else if (['string', 'number', 'boolean'].indexOf(objType) >= 0) {
                return obj; // will toString
            }
            // objType == 'object'
            var res = '{';
            for (p in obj) { // property in object
                if (typeof(onlyProps) !== 'undefined' && onlyProps) {
                    // Only show property names as values may show too much noise.
                    // After this you can trace more specific properties to debug
                    res += p + ', ';
                } else {
                    var valType = typeof(obj[p]);
                    if (typeof(skipTypes) == 'undefined') {
                        skipTypes = ['function'];
                    }
                    if (skipTypes.indexOf(valType) >= 0) {
                        res += p + ': ' + valType + ', ';
                    } else {
                        res += p + ': ' + obj[p] + ', ';
                    }
                }
            }
            res += '}';
            return res;
        }

        function saveas() {
            //$('[data-toggle="popover"]').popover(); 
            var con = "<form action='http://140.121.197.135:7778/servrel/workspace/project?project=projectname%data=root' method='post'><input type='text' data-provide='typeahead' id='projectname'><input class='btn btn-primary' type='submit' value='OK'></form>";
            $('#SaveAs').popover({
                title: 'Project Name:',
                trigger: 'click',
                html: true,
                content: con,
            });
            console.log(root);
            // alert(root);				
        }

        function addFavorAPI(apiName) {
            var cate = $("#selectClass").val();
            var newName;
			var site;
            console.log("name: " + apiName);
            console.log("class: " + cate);
            if (cate == "newCategory") {
                newName = $("#newClass").val();
                site = "http://140.121.197.135:7778/servrel/favorite?category=" + newName + "&api=" + apiName + "&userID=" + localStorage.userID;
            } else {
                site = "http://140.121.197.135:7778/servrel/favorite?category=" + cate + "&api=" + apiName + "&userID=" + localStorage.userID;
            }
			
			$.post(site, function(result) {
                    console.log("addAPI: " + JSON.stringify(result));
					if (result.code == "200") {
						alert("OK!");
						layer.close(layer.tips());
                    }
			}, "json");

        }

        function popWindow(apiid) {
            var site = "http://140.121.197.135:7778/servrel/api/info?id=" + apiid;
            $.post(site, function(data) {
                var show = "<table id='wfInfo'><tr><td><img src='workspacepeople_title.png'></td><td>" + data.workspacepeople + "</td><td><img id='favorimg' src='favorpeople.png'></td><td>" + data.favorpeople + "</td></tr></table><p style='margin-top:40px;'><span class='item'>API name : </span>" + data.Info.name + "<br><span class='item'>Introduction : </span>" + data.Info.introduction + "<br><span class='item'>Host URL : </span>" + data.Info.hostUrl + "<br><span class='item'>Path : </span>" + data.Info.path + "<br><span class='item'>Http method : </span>" + data.Info.httpMethod + "<br><span class='item'>Content type : </span>" + data.Info.contentType + "<br><span class='item'>API endpoint : </span>" + data.Info.apiEndpoint + "</p>";

                var para = data.request;
                show += "<table id='APItest' rules='rows'><tr><td style='border-right:1px black solid;width:10%;'>param</td><td style='width:70%;text-align:left;padding-left:1%;'>";

                $.each(para, function() {
                    if (this.testData != undefined) {
                        show += this.name + ": <input type='text' id='" + apiid + "_pop_" + this.name + "' value='" + this.testData + "'><br>";
                    } else {
                        show += this.name + ": <input type='text' id='" + apiid + "_pop_" + this.name + "' value='" + this.defaultValue + "' disabled><br>";
                    }
                });

                show += "</td><td><input type='button' class='popTestbtn' id='popTestBtn_" + apiid + "' value='test'></td></tr><tr><td style='border-right:1px black solid;width:10%;'>result</td><td colspan='2'  style='padding:1%;'><div class='popTestResult' id='popTest_" + apiid + "' style='padding:0.5%;'></div></td></tr></table>";

                layer.open({
                    type: 1,
                    title: 'API Information',
                    closeBtn: 0,
                    shadeClose: true,
                    area: ['50%', '80%'],
                    skin: 'mySkin',
                    content: show
                });

                var testbtn = "#popTestBtn_" + apiid;
                $(testbtn).on("click", function() {
					var datas = [];
					var testJson = "{\"request\":";
					
					$.each(para, function() {
						var d = {};
						d["parameterpath"] = this.parameterpath;
						d["testData"] = $("#" + apiid + "_pop_" + this.name).val();
						d["name"] = this.name;
						datas.push(d);
						
					});
					
					testJson += JSON.stringify(datas) + ",";
					testJson += "\"Info\":";
					
					var testInfo = new Object();
					testInfo.path = data.Info.path;;
					testInfo.hostUrl = data.Info.hostUrl;
					testInfo.httpMethod = data.Info.httpMethod;
					testInfo.contentType = data.Info.contentType;
					testJson += JSON.stringify(testInfo) + "}";
					
					console.log("r: " + testJson);
					
					var site = "http://140.121.197.135:7778/servrel/callapi";
					$.post(site, {"test": testJson}, function(result){
						$("#popTest_" + apiid).text(JSON.stringify(result));
					}, "json");
					
                });

                if (localStorage.userID != undefined) {
                    $('#favorimg').hover(function() {
                        $(this).attr("src", "addfavor.png");
                        $(this).css("cursor", "pointer");
                    }, function() {
                        $(this).attr("src", "favorpeople.png");
                    });

                    $('#favorimg').click(function() {
                        var con = "<form action='JavaScript:addFavorAPI(\"" + data.api + "\")'><center><font size=5>Category</font><hr color='#08605F' style='margin: 5px;'></center><div><select id='selectClass'>";

                        var site = "http://140.121.197.135:7778/servrel/favorite?userID=" + localStorage.userID;
                        $.getJSON(site, function(result) {
                            $.when($.each(result, function() {
                                con += "<option value='" + this + "'>" + this + "</option>";

                            })).done(function() {
                                con += "<option value='newCategory'>Create a new category</option></select><br><input type='text' id='newClass' placeholder='Category name' required></div><input class='favorOK' type='submit' value='OK'></form>";


                                layer.tips(con, "#favorimg", {
                                    tips: [3, '#3BA99C'],
                                    time: 0,
                                    skin: 'favorTip',
                                    shade: [0, '#FFFFF'],
                                    shadeClose: true
                                });
								
								
								
                                if ($("#selectClass").val() != "newCategory") {
                                    $("#newClass").hide();
                                    $("#newClass").val("no");
                                }

                                $("#selectClass").change(function() {
                                    if ($("#selectClass").val() == "newCategory") {
                                        $("#newClass").val("");
                                        $("#newClass").show();
                                    } else {
                                        $("#newClass").hide();
                                        $("#newClass").val("no");
                                    }
                                });

                            });

                        });

                    });
                }
            }, "json");
            d3.event.stopPropagation();
        }

        function showInfo(data, apiid) {
            //<p style='font-size:36px;font-weight:bolder;margin: 6px 0 3px 0;'>API Information</p>
            var show = "<div><p style='margin: 0 0 2px 0;'><span class='item'>API name : </span>" + data.Info.name + "<br><span class='item'>Introduction : </span>" + data.Info.introduction + "<br><span class='item'>Host URL : </span>" + data.Info.hostUrl + "<br><span class='item'>Path : </span>" + data.Info.path + "<br><span class='item'>Http method : </span>" + data.Info.httpMethod + "<br><span class='item'>Content type : </span>" + data.Info.contentType + "<br><span class='item'>API endpoint : </span>" + data.Info.apiEndpoint + "</p></div>";

            var para = data.request;
            show += "<table id='APItest' rules='rows'><tr><td style='border-right:1px black solid;width:10%;'>param</td><td style='width:70%;padding-left:1%;'><div style='height:70px;overflow:auto;text-align:left;'>";

            $.each(para, function() {
                if (this.testData != undefined) {
                    show += this.name + ": <input type='text' id='" + apiid + "_" + this.name + "' value='" + this.testData + "'><br>";
                } else {
                    show += this.name + ": <input type='text' id='" + apiid + "_" + this.name + "' value='" + this.defaultValue + "' disabled><br>";
                }
            });
            show += "</div></td><td><input type='button' class='testbtn' id='testbtn_" + apiid + "' value='test'></td></tr><tr><td style='border-right:1px black solid;width:10%;'>result</td><td colspan='2' style='padding:1%;'><div class='testResult' id='test_" + apiid + "'></div></td>";

            var dataid = "#info_" + apiid;
            $(dataid).html(show);

            var testbtn = "#testbtn_" + apiid;
            $(testbtn).click(function() {
				var datas = [];
				var testJson = "{\"request\":";
                
                $.each(para, function() {
                    var d = {};
					d["parameterpath"] = this.parameterpath;
					d["testData"] = $("#" + apiid + "_" + this.name).val();
					d["name"] = this.name;
					datas.push(d);
					
                });
				
				testJson += JSON.stringify(datas) + ",";
				testJson += "\"Info\":";
				
				var testInfo = new Object();
				testInfo.path = data.Info.path;;
				testInfo.hostUrl = data.Info.hostUrl;
				testInfo.httpMethod = data.Info.httpMethod;
				testInfo.contentType = data.Info.contentType;
				testJson += JSON.stringify(testInfo) + "}";
				
				console.log("r: " + testJson);
				
				var site = "http://140.121.197.135:7778/servrel/callapi";
				$.post(site, {"test": testJson}, function(result){
					$("#test_" + apiid).text(JSON.stringify(result));
				}, "json");
				
            });

        }

        function getInfo(apiid, id) {
            var site = "http://140.121.197.135:7778/servrel/api/info?id=" + id;
            console.log(site);
            $.post(site, function(result) {
                console.log("post: " + JSON.stringify(result));
                showInfo(result, id);
            }, "json");

        }

        function getRelativeAPI(data, type, apiid) {
            var lang = "";
            if (type == "pre")
                lang = "<p style='font-size:36px;font-weight:bolder;margin: 6px 0 4px 0;'>Pre-Cooperation API</p>";
            if (type == "pos")
                lang = "<p style='font-size:36px;font-weight:bolder;margin: 6px 0 4px 0;'>Post-Cooperation API</p>";
            if (type == "com")
                lang = "<p style='font-size:36px;font-weight:bolder;margin: 6px 0 4px 0;'>Competition API</p>";

            lang += "<table class='reAPITable' rules='rows'><tbody>";

            var a = new Array();

            if (JSON.stringify(data) != "[]") {
                $.each(data, function() {
                    a = this['name'].split(".json", 1);
                    lang += "<tr><td style='width:20%;'><img id=rel_" + this.id + " class='relogo' title=" + a[0] + " draggable='true' ondragstart='dragstartHandler(event)' src=" + hasPic(this.pic) + "></td><td>" + a[0] + "</td></tr>";

                });
            } else {
                lang += "<tr><td colspan='2'><h3>No corresponding API</h3></td></tr>"
            }

            lang += "</tbody></table>";
            var dataid = type + "_" + apiid;
            document.getElementById(dataid).innerHTML = lang;
        }

        function getPre(apiid, id) {
            //var site = "http://bluemix-siri.mybluemix.net/apis/cooperative/pre?id=" + apiid;
            var site = "http://140.121.197.135:7778/servrel/apis/cooperative/pre?id=" + id;
            $.getJSON(site, function(result) {
                getRelativeAPI(result, "pre", id);
                console.log(site);
                //console.log(result);
            });
        }

        function getPost(apiid, id) {
            //var site = "http://bluemix-siri.mybluemix.net/apis/cooperative/post?id=" + apiid;
            var site = "http://140.121.197.135:7778/servrel/apis/cooperative/post?id=" + id;
            $.getJSON(site, function(result) {
                getRelativeAPI(result, "pos", id);
                console.log(site);
                //console.log(result);
            });
        }

        function getComp(apiid, id) {
            //var site = "http://bluemix-siri.mybluemix.net/apis/competitive?id=" + apiid;
            var site = "http://140.121.197.135:7778/servrel/apis/competitive?id=" + id;
            $.getJSON(site, function(result) {
                getRelativeAPI(result, "com", id);
                console.log(site);
                //console.log(result);
            });
        }

        function getSearchForm() {
            $("input[name='searchtype']").change(function() {
                t = $("input[name='searchtype']:checked").val();
                if (t == "keyword") {
                    formCon = "Keyword: <input type='text' id='keyword'>";
                    $("#searchContent").html(formCon);
                } else {
                    formCon = "Description: <input type='text' id='description'><br><table id='inTable'><tr><td>Input: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input name='inputs' type='text'><br>TestData: <input name='testdata' type='text'></td></tr></table><img id='inBtn' class='add' src='addItem.png' onclick='addIn()'><table id='outTable'><tr><td>Output: &nbsp;&nbsp;&nbsp;&nbsp;<input name='outputs' type='text'><br><div id='field_exp_1'>Expected: <input name='exp_1' type='text'><img class='addExp' id='exp_1' src='addButton.jpg' style='width:16px'></div></td></tr></table><img id='outBtn' class='add' src='addItem.png' onclick='addOut()'>";
                    $("#searchContent").html(formCon);
                }
            });
        }


        var graphSize = 1;


        $(document).ready(function() {
            var t = $("input[name='searchtype']:checked").val();
            var formCon = "";
            if (t == "keyword") {
                formCon = "Keyword: <input type='text' id='keyword'>";
                $("#searchContent").html(formCon);
            } else {
                formCon = "Description: <input type='text' id='description'><br><table id='inTable'><tr><td>Input: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input name='inputs' type='text'><br>TestData: <input name='testdata' type='text'></td></tr></table><img id='inBtn' class='add' src='addItem.png' onclick='addIn()'><table id='outTable'><tr><td>Output: &nbsp;&nbsp;&nbsp;&nbsp;<input name='outputs' type='text'><br><div id='field_exp_1'>Expected: <input name='exp_1' type='text'><img class='addExp' id='exp_1' src='addButton.jpg' style='width:16px'></div></td></tr></table><img id='outBtn' class='add' src='addItem.png' onclick='addOut()'>";
                $("#searchContent").html(formCon);
            }
            getSearchForm();
           
            $(document).on("click", ".addExp", function() {
                var fieldID = "#field_" + this.id;
                $(fieldID).append("<br>Expected: <input name=" + this.id + " type='text'>");
            });
			 $(".list-group-item").click(function() {
							console.log("有執行ㄇ");
							clearAll();
							svg=getDraw();
							console.log(this.id);
							var site = "http://140.121.197.135:7778/servrel/workspace/project?userID=" + localStorage.userID + "&project=" + this.id;
							$.getJSON(site, function(data) {
								console.log(data);
								//console.log(data.data);
								root = data.data;
								console.log("有執行ㄇ");
								//root = root.substr(1, root.length - 2);
								//console.log(root);
								//root = root.toString(root);
								//root=JSON.parse(root);
								// root=JSON.stringify(root);
								root = eval(root);
								console.log(root);
								WdrawBall(svg, 2);
							});
						});
            $("#graphBar").click(function() {
                if (graphSize % 2 == 0) {
                    $("#saveButton").css({
                        width: "100%",
                        left: "0%"
                    });
                } else {
                    $("#saveButton").css({
                        width: "50%",
                        left: "50%"
                    });
                }
                $("#saveButton").slideToggle("normal");
            });

            $("#showGraph").bind("click", function(e) {
                e.stopPropagation();
                if (graphSize % 2 == 1) {
                    $("#graphBar").animate({
                        width: "100%",
                        left: "0%"
                    }, "normal");
                    $("#visualization").animate({
                        width: "100%",
                        left: "0%"
                    }, "normal");
                    $("#saveButton").animate({
                        width: "100%",
                        left: "0%"
                    }, "normal");
                } else {
                    $("#graphBar").animate({
                        width: "50%",
                        left: "50%"
                    }, "normal");
                    $("#visualization").animate({
                        width: "50%",
                        left: "50%"
                    }, "normal");
                    $("#saveButton").animate({
                        width: "50%",
                        left: "50%"
                    }, "normal");
                }
                graphSize++;
            });

            $("#flotTag").hover(function() {
                $(this).animate({
                    margin: "-10px 0 0 -185px",
                    width: "185px",
                    height: "130px"
                }, "fast");
            }, function() {
                $(this).animate({
                    margin: "0 0 0 -35px",
                    width: "31px",
                    height: "26px"
                }, "fast");
            });

        });
    </script>

</head>

<body>

    <div id="topBar">
        <a href="mixList.html" title="index"><img id="top_name" src="title.jpg" alt="picture" /></a>
    </div>

    <input type="button" id="listBar" value="Result List" onclick="backSearch()">

    <div id="graphBar"><img id="showGraph" src="showGraph.png"></img>Service Graph</div>
    <div id="saveButton">
        <button type="button" class="saveBtn" data-placement="bottom" data-toggle="popover" id="New" onclick='newgraph()'>New</button>
        <button type="button" class="saveBtn" data-placement="bottom" data-toggle="popover" id="Open" onclick='openProject()'>Open</button>
        <button type="button" class="saveBtn" data-placement="bottom" data-toggle="popover" id="Save" onclick='savedata()'>Save</button>
        <button type="button" class="saveBtn" data-placement="bottom" data-toggle="popover" id="SaveAs" onclick='saveas()'>Save As</button>
    </div>

    <!--svg id="load" width="97%" height="250" onclick="gauge1.update(NewValue());"></svg-->
    <div id="load">
        <img src="loading.gif"></img>
        Searching...<br>Please wait
    </div>

    <div id="leftPart" class="left">
        <div id="searchForm">

            <form method="get" action="JavaScript:search()">
                <div class="searchType">
                    <input type="radio" id="keywordtype" name="searchtype" value="keyword" checked="true">
                    <label for="keywordtype">Search by keyword</label>
                    <input type="radio" id="IO" name="searchtype" value="IO">
                    <label for="IO">Search by inputs and outputs</label>
                </div>
                <div id="searchContent">

                </div>
                <input type="submit" id="go" value="search">
            </form>
        </div>
    </div>

    <div id="visualization" class="draw" ondragover="dragoverHandler(event)" ondrop="dropHandler(event)">

    </div>

    <div id="flotTag">
        <table id="pageLink">
            <tr>
                <td><img src="accountPic.png" /></td>
                <td><a id="accLink" href="login.html">Account</a></td>
            </tr>
            <tr>
                <td><img src="workPic.png" /></td>
                <td><a id="workLink" href="workspace.html">Workspace</a></td>
            </tr>
            <tr>
                <td><img src="favoritePic.png" /></td>
                <td><a id="favLink" href="favorite.html">Favorite API</a></td>
            </tr>
            <tr>
                <td><img src="myAPIPic.png" /></td>
                <td><a id="myLink" href="MyAPI.html">My API</a></td>
            </tr>
        </table>
    </div>

</body>

</html>